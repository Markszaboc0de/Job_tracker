<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Career Opportunity Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4 sm:p-8">
    <div id="app" class="max-w-4xl mx-auto">
        <header class="text-center mb-10">
            <h1 class="text-4xl font-extrabold text-indigo-700">Career Opportunity Tracker</h1>
            <p class="mt-2 text-gray-500">Add career sites to track and export job opportunities to Excel</p>
        </header>

        <!-- Add New Site Form -->
        <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Add New Career Site to Track</h2>
            <div class="flex flex-col sm:flex-row gap-3">
                <input type="text" id="site-url-input" placeholder="Career Site URL (e.g., https://careers.company.com)"
                       class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                <input type="text" id="company-name-input" placeholder="Company Name (optional)"
                       class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                <button onclick="addTrackedSite()" id="add-site-btn"
                        class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-150 ease-in-out disabled:opacity-50">
                    Add Site
                </button>
            </div>
        </div>

        <!-- Export Section -->
        <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
            <div class="flex justify-between items-center">
                <div>
                    <h2 class="text-xl font-semibold text-gray-700">Export Options</h2>
                    <p class="text-sm text-gray-500 mt-1">Download all job opportunities as Excel file</p>
                </div>
                <button onclick="exportToExcel()" id="export-btn"
                        class="bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-6 rounded-lg shadow transition duration-150 ease-in-out flex items-center disabled:opacity-50">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    Export to Excel
                </button>
            </div>
        </div>

        <!-- Tracking List -->
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-semibold text-gray-700">Tracked Sites</h2>
                <button onclick="refreshAllJobs()" id="refresh-all-btn"
                        class="bg-green-500 hover:bg-green-600 text-white font-medium py-2 px-4 rounded-lg shadow transition duration-150 ease-in-out flex items-center disabled:opacity-50">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m15.356 2H21m-6.046 2.01l-1.42 1.42a2 2 0 01-2.828 0l-1.42-1.42m5.676 0L17.76 14.43a2 2 0 010 2.828l-1.42 1.42m-5.676 0l1.42 1.42a2 2 0 012.828 0l1.42-1.42"></path>
                    </svg>
                    Refresh All
                </button>
            </div>
            
            <div id="site-list" class="space-y-4">
                <p id="loading-sites" class="text-center text-gray-500">Loading tracked sites...</p>
            </div>
        </div>

        <!-- Modal for displaying jobs -->
        <div id="job-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                <div class="p-6">
                    <div class="flex justify-between items-start mb-4">
                        <h3 id="modal-title" class="text-2xl font-bold text-gray-800">Jobs</h3>
                        <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 transition">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <div id="job-list-content" class="space-y-4">
                        <!-- Job opportunities will be inserted here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Global Status Message -->
        <div id="status-message" class="fixed bottom-4 right-4 p-4 bg-indigo-500 text-white rounded-lg shadow-xl transition-opacity duration-300 opacity-0 pointer-events-none z-50">
            Processing...
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        let trackedSites = [];

        const statusEl = document.getElementById('status-message');
        const siteListEl = document.getElementById('site-list');
        const addSiteBtn = document.getElementById('add-site-btn');
        const refreshAllBtn = document.getElementById('refresh-all-btn');
        const exportBtn = document.getElementById('export-btn');

        function showStatus(message, duration = 3000) {
            statusEl.textContent = message;
            statusEl.classList.remove('opacity-0', 'pointer-events-none');
            setTimeout(() => {
                statusEl.classList.add('opacity-0', 'pointer-events-none');
            }, duration);
        }

        async function loadTrackedSites() {
            try {
                const response = await fetch(`${API_BASE}/api/sites`);
                if (!response.ok) throw new Error('Failed to load sites');
                trackedSites = await response.json();
                renderSiteList();
            } catch (error) {
                console.error('Error loading sites:', error);
                showStatus('Error loading sites: ' + error.message, 5000);
                siteListEl.innerHTML = '<p class="text-center text-red-500 py-4">Error loading sites. Make sure the server is running.</p>';
            }
        }

        window.addTrackedSite = async function() {
            const urlInput = document.getElementById('site-url-input');
            const nameInput = document.getElementById('company-name-input');
            const url = urlInput.value.trim();
            const companyName = nameInput.value.trim();

            if (!url) {
                showStatus('Please enter a career site URL.', 3000);
                return;
            }

            addSiteBtn.disabled = true;
            showStatus(`Adding site: ${url}...`, 3000);

            try {
                const response = await fetch(`${API_BASE}/api/sites`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url, companyName })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to add site');
                }

                urlInput.value = '';
                nameInput.value = '';
                await loadTrackedSites();
                showStatus('Site added successfully!', 3000);
            } catch (error) {
                console.error('Error adding site:', error);
                showStatus('Failed to add site: ' + error.message, 5000);
            } finally {
                addSiteBtn.disabled = false;
            }
        }

        window.refreshJobs = async function(siteId, companyName) {
            showStatus(`Refreshing jobs for ${companyName}... This may take a moment.`, 15000);
            refreshAllBtn.disabled = true;

            try {
                const response = await fetch(`${API_BASE}/api/sites/${siteId}/refresh`, {
                    method: 'POST'
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to refresh jobs');
                }

                const result = await response.json();
                await loadTrackedSites();
                showStatus(`Successfully refreshed ${companyName}. Found ${result.jobCount} jobs.`, 4000);
            } catch (error) {
                console.error('Error refreshing jobs:', error);
                showStatus('Failed to refresh jobs: ' + error.message, 5000);
            } finally {
                refreshAllBtn.disabled = false;
            }
        }

        window.refreshAllJobs = async function() {
            if (trackedSites.length === 0) {
                showStatus('No sites to refresh.', 3000);
                return;
            }

            showStatus(`Refreshing all ${trackedSites.length} sites... This will take a while.`, 30000);
            refreshAllBtn.disabled = true;

            try {
                const response = await fetch(`${API_BASE}/api/sites/refresh/all`, {
                    method: 'POST'
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to refresh all jobs');
                }

                const result = await response.json();
                await loadTrackedSites();
                showStatus('All sites refreshed! Excel file updated.', 5000);
            } catch (error) {
                console.error('Error refreshing all jobs:', error);
                showStatus('Failed to refresh all jobs: ' + error.message, 5000);
            } finally {
                refreshAllBtn.disabled = false;
            }
        }

        window.viewJobs = async function(siteId, companyName) {
            const listContent = document.getElementById('job-list-content');
            const modalTitle = document.getElementById('modal-title');
            
            modalTitle.textContent = `Loading Jobs for ${companyName}...`;
            listContent.innerHTML = '<div class="text-center text-gray-500 py-8">Fetching latest jobs...</div>';
            openModal();

            try {
                const response = await fetch(`${API_BASE}/api/sites/${siteId}/jobs`);
                if (!response.ok) throw new Error('Failed to load jobs');
                
                const jobs = await response.json();
                modalTitle.textContent = `Jobs for ${companyName} (${jobs.length})`;
                
                if (jobs.length === 0) {
                    listContent.innerHTML = `<div class="p-4 bg-gray-100 rounded-lg text-center text-gray-600">No jobs found. Click 'Refresh Now' to scrape jobs from the career site.</div>`;
                } else {
                    listContent.innerHTML = jobs.map(job => `
                        <div class="p-4 border border-gray-200 rounded-lg hover:shadow-md transition duration-150">
                            <h4 class="font-semibold text-lg text-indigo-600">${escapeHtml(job.title)}</h4>
                            <p class="text-sm text-gray-700">${escapeHtml(job.location)}</p>
                            <p class="mt-1 text-gray-500 text-sm">${escapeHtml(job.summary)}</p>
                            ${job.url ? `<a href="${job.url}" target="_blank" class="text-indigo-500 text-sm mt-2 inline-block">View Job â†’</a>` : ''}
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Error viewing jobs:', error);
                listContent.innerHTML = `<div class="p-4 bg-red-100 rounded-lg text-center text-red-700">Error loading jobs: ${error.message}</div>`;
            }
        }

        window.deleteSite = async function(siteId, companyName) {
            if (!confirm(`Are you sure you want to delete tracking for ${companyName}? This will also delete all associated job data.`)) {
                return;
            }

            showStatus(`Deleting ${companyName}...`, 3000);
            try {
                const response = await fetch(`${API_BASE}/api/sites/${siteId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to delete site');
                }

                await loadTrackedSites();
                showStatus(`Successfully deleted ${companyName}.`, 3000);
            } catch (error) {
                console.error('Error deleting site:', error);
                showStatus('Failed to delete site: ' + error.message, 5000);
            }
        }

        window.exportToExcel = async function() {
            exportBtn.disabled = true;
            showStatus('Exporting to Excel...', 3000);

            try {
                const response = await fetch(`${API_BASE}/api/export/excel`);
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to export');
                }

                // Download the file
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'job_opportunities.xlsx';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                showStatus('Excel file downloaded successfully!', 3000);
            } catch (error) {
                console.error('Error exporting to Excel:', error);
                showStatus('Failed to export: ' + error.message, 5000);
            } finally {
                exportBtn.disabled = false;
            }
        }

        function openModal() {
            document.getElementById('job-modal').classList.remove('hidden');
            document.getElementById('job-modal').classList.add('flex');
        }

        window.closeModal = function() {
            document.getElementById('job-modal').classList.add('hidden');
            document.getElementById('job-modal').classList.remove('flex');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function renderSiteList() {
            if (trackedSites.length === 0) {
                siteListEl.innerHTML = '<p class="text-center text-gray-500 py-4">No sites currently being tracked. Add one above!</p>';
                return;
            }

            siteListEl.innerHTML = trackedSites.map(site => {
                const lastRefreshed = site.lastRefreshed 
                    ? new Date(site.lastRefreshed).toLocaleString() 
                    : 'Never';
                
                const cardColor = site.jobCount > 0 ? 'bg-indigo-50 border-indigo-200' : 'bg-gray-50 border-gray-200';

                return `
                    <div class="flex flex-col sm:flex-row items-center p-4 border rounded-xl shadow-sm ${cardColor}">
                        <div class="flex-grow min-w-0 mb-3 sm:mb-0">
                            <p class="text-lg font-medium text-gray-800 truncate">${escapeHtml(site.companyName || site.url)}</p>
                            <p class="text-xs text-gray-500 break-all">${escapeHtml(site.url)}</p>
                            <p class="text-xs text-gray-500 mt-1">Last Refreshed: ${lastRefreshed}</p>
                            <p class="text-sm font-bold text-indigo-600">${site.jobCount} Jobs Found</p>
                        </div>
                        
                        <div class="flex flex-wrap justify-center sm:justify-end gap-2 ml-4">
                            <button onclick="viewJobs('${site.id}', '${escapeHtml(site.companyName || site.url)}')" 
                                class="text-sm bg-indigo-500 hover:bg-indigo-600 text-white py-2 px-3 rounded-lg transition duration-150 shadow-md">
                                View Jobs
                            </button>
                            <button onclick="refreshJobs('${site.id}', '${escapeHtml(site.companyName || site.url)}')" 
                                class="text-sm bg-green-500 hover:bg-green-600 text-white py-2 px-3 rounded-lg transition duration-150 shadow-md">
                                Refresh Now
                            </button>
                            <button onclick="deleteSite('${site.id}', '${escapeHtml(site.companyName || site.url)}')" 
                                class="text-sm bg-red-500 hover:bg-red-600 text-white py-2 px-3 rounded-lg transition duration-150 shadow-md">
                                Delete
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Initialize
        loadTrackedSites();
    </script>
</body>
</html>

